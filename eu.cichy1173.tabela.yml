app-id: eu.cichy1173.tabela
runtime: org.kde.Platform
runtime-version: '6.5'
sdk: org.kde.Sdk
command: tabela
finish-args:
  - --share=ipc
  - --share=network
  - --socket=x11
  - --device=dri
  - --filesystem=host

sdk-extensions:
  - org.freedesktop.Sdk.Extension.llvm16
build-options:
    append-path: /usr/lib/sdk/llvm16/bin
    prepend-ld-library-path: /usr/lib/sdk/llvm16/lib

modules:
  - name: qt-include
    # https://bugreports.qt.io/projects/PYSIDE/issues/PYSIDE-787
    buildsystem: simple
    build-commands:
      - mkdir -p /app/include/qt
      - cp -R /usr/include/Qt* /app/include/qt
    cleanup:
      - /include

  - name: PySide6
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DBUILD_TESTS=OFF
    sources:
      - type: archive
        url: https://download.qt.io/official_releases/QtForPython/pyside6/PySide6-6.5.1.1-src/pyside-setup-everywhere-src-6.5.1.1.tar.xz
        sha256: 9741a06f0b7d4b2168818448134bc7e96ddb5efb846a3915b4177ba4159b5b78
      - type: shell
        commands:
          # use qt-include
          - sed -i 's|\(--include-paths=\)|\1/app/include/qt:|' sources/pyside6/cmake/Macros/PySideModules.cmake
          # fix python module search path
          - sed -i '/--sys-path\b/ a "${pysidebindings_BINARY_DIR}/.."' sources/pyside6/cmake/Macros/PySideModules.cmake
    cleanup:
      - /plugins
      - /include
      - /bin
  - name: tabela
    buildsystem: simple
    build-commands:
      - python -m pip install --no-deps --no-build-isolation --prefix=/app .
      - mkdir -p /app/share/applications
      - cp data/eu.cichy1173.tabela.desktop /app/share/applications
      - mkdir -p /app/share/metainfo
      - cp data/eu.cichy1173.tabela.metainfo.xml /app/share/metainfo
      - mkdir -p /app/share/icons/hicolor/48x48/apps
      - cp data/icons/hicolor/apps/48x48/eu.cichy1173.tabela.png /app/share/icons/hicolor/48x48/apps
      - mkdir -p /app/share/icons/hicolor/128x128/apps
      - cp data/icons/hicolor/apps/128x128/eu.cichy1173.tabela.png /app/share/icons/hicolor/48x48/apps
    sources:
      - type: git
        url: https://codeberg.org/cichy1173/tabela-flatpak.git
        tag: v1.0.8
        commit: 1bc76b91078cfc50da42f49d7c0e5624304ddb91
